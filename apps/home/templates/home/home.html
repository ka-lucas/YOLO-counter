{% extends 'home/base.html' %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
{% load static %}

<div class="mb-3">
  <h2 class="mb-0">Dashboard</h2>
  <p class="text-muted">Monitoramento em tempo real</p>
</div>

<!-- CARDS PRINCIPAIS -->
<div class="row g-3 mb-4">
  <div class="col-lg-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <small class="text-muted">Total de Suínos Detectados Hoje</small>
          <h3 class="mb-0">{{ today_detected }}</h3>
          <small class="{% if detected_change >= 0 %}text-success{% else %}text-danger{% endif %}">
            {% if detected_change >= 0 %}↑{% else %}↓{% endif %} {{ detected_change|floatformat:0 }}% comparado a ontem
          </small>
        </div>
        <div class="icon-circle bg-success text-white">
          <i data-lucide="activity"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <small class="text-muted">Entradas</small>
        <h3 class="mb-0">{{ today_in }}</h3>
        <small class="{% if in_change >= 0 %}text-success{% else %}text-danger{% endif %}">
          {% if in_change >= 0 %}↑{% else %}↓{% endif %} {{ in_change|floatformat:0 }}%
        </small>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <small class="text-muted">Saídas</small>
        <h3 class="mb-0">{{ today_out }}</h3>
        <small class="{% if out_change >= 0 %}text-success{% else %}text-danger{% endif %}">
          {% if out_change >= 0 %}↑{% else %}↓{% endif %} {{ out_change|floatformat:0 }}%
        </small>
      </div>
    </div>
  </div>
</div>

<!-- GRÁFICO + VÍDEO -->
<div class="row g-3 mb-4">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="mb-3">
          <h5 class="mb-0">Evolução das Contagens</h5>
          <small class="text-muted">Últimos 7 dias - Entradas vs Saídas vs Saldo</small>
        </div>
        <div style="height: 300px;">
          <canvas id="movementChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Visão ao Vivo</h6>
          <span class="badge bg-danger">REC</span>
        </div>

        <div class="video-container mb-3 position-relative">
          <div class="w-100 rounded bg-dark d-flex align-items-center justify-content-center" style="height: 200px;">
            <div class="text-white text-center">
              <i data-lucide="camera-off" class="mb-2" style="width: 48px; height: 48px;"></i>
              <p class="mb-0">Nenhuma câmera disponível</p>
              <small class="text-muted">Cadastre uma câmera nas configurações</small>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2">
          <a href="{% url 'cameras:create' %}" class="btn btn-primary w-100">
            <i data-lucide="plus"></i>
            Adicionar Câmera
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STATUS + ALERTAS -->
<div class="row g-3">
  <div class="col-lg-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h6>Status do Dispositivo</h6>

        <div class="mb-3">
          <small>{% if gpu_available %}GPU{% else %}CPU{% endif %}</small>
          <div class="progress">
            <div class="progress-bar {% if gpu_usage < 50 %}bg-success{% elif gpu_usage < 80 %}bg-warning{% else %}bg-danger{% endif %}" style="width: {{ gpu_usage }}%"></div>
          </div>
          <small class="text-muted">{{ gpu_usage|floatformat:0 }}%</small>
        </div>

        <div class="mb-3">
          <small>FPS Inferência</small>
          <div class="progress">
            <div class="progress-bar bg-info" style="width: 65%"></div>
          </div>
          <small class="text-muted">23 FPS</small>
        </div>

        <div class="mb-3">
          <small>Temperatura</small>
          <div class="progress">
            <div class="progress-bar {% if temp_usage < 60 %}bg-success{% elif temp_usage < 80 %}bg-warning{% else %}bg-danger{% endif %}" style="width: {{ temp_usage }}%"></div>
          </div>
          <small class="text-muted">{{ temp_usage|floatformat:0 }}°C</small>
        </div>

        <div>
          <small>Memória RAM</small>
          <div class="progress">
            <div class="progress-bar {% if ram_usage < 60 %}bg-primary{% elif ram_usage < 80 %}bg-warning{% else %}bg-danger{% endif %}" style="width: {{ ram_usage }}%"></div>
          </div>
          <small class="text-muted">{{ ram_usage|floatformat:0 }}%</small>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h6>Fluxo por Minuto</h6>
        <small class="text-muted">Últimos 10 minutos</small>
        <div style="height: 160px;">
          <canvas id="minuteChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6>Alertas Inteligentes</h6>
          <small class="text-muted">3 novos</small>
        </div>

        <ul class="list-group list-group-flush">
          <li class="list-group-item">
            <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
            Câmera 02 com baixa luminosidade<br>
            <small class="text-muted">há 5 min</small>
          </li>

          <li class="list-group-item">
            <i class="bi bi-check-circle-fill text-success me-1"></i>
            Modelo atualizado com sucesso<br>
            <small class="text-muted">há 20 min</small>
          </li>

          <li class="list-group-item">
            <i class="bi bi-exclamation-octagon-fill text-danger me-1"></i>
            Movimentação anormal detectada<br>
            <small class="text-muted">há 1 hora</small>
          </li>
        </ul>

      </div>
    </div>
  </div>
</div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  let movementChart = null;
  let minuteChart = null;

  // Função para atualizar gráficos com dados em tempo real
  function updateCharts() {
    fetch('/video-ao-vivo/api/chart-data/')
      .then(response => response.json())
      .then(data => {
        console.log('Dados recebidos:', data); // Debug
        if (data.ok) {
          updateMovementChart(data.hourly_data);
          updateMinuteChart(data.minute_data);
        } else {
          console.error('Erro na resposta:', data.error);
          initializeWithStaticData();
        }
      })
      .catch(error => {
        console.error('Erro ao buscar dados dos gráficos:', error);
        initializeWithStaticData();
      });
  }

  // Função para inicializar com dados estáticos
  function initializeWithStaticData() {
    const staticHourlyData = [{% for hour_data in hourly_data %}{hour: "{{ hour_data.hour }}", in: {{ hour_data.in }}, out: {{ hour_data.out }}}{% if not forloop.last %},{% endif %}{% endfor %}];
    const staticMinuteData = [{% for minute_val in minute_data %}{{ minute_val }}{% if not forloop.last %},{% endif %}{% endfor %}];
    
    console.log('Dados estáticos:', {hourly: staticHourlyData, minute: staticMinuteData}); // Debug
    
    updateMovementChart(staticHourlyData.length > 0 ? staticHourlyData : generateEmptyHourlyData());
    updateMinuteChart(staticMinuteData.length > 0 ? staticMinuteData : [0,0,0,0,0,0,0,0,0,0]);
  }

  // Função para gerar dados vazios por hora
  function generateEmptyHourlyData() {
    const data = [];
    const now = new Date();
    for (let i = 8; i >= 0; i--) {
      const hour = new Date(now.getTime() - i * 60 * 60 * 1000);
      data.push({
        hour: hour.getHours().toString().padStart(2, '0') + ':00',
        in: 0,
        out: 0
      });
    }
    return data;
  }

  // Função para atualizar contadores em tempo real
  function updateCounters() {
    fetch('/video-ao-vivo/api/status/')
      .then(response => response.json())
      .then(data => {
        if (data.running) {
          // Atualizar cards com dados em tempo real
          const totalDetected = data.in + data.out;
          document.querySelector('h3').textContent = totalDetected;
          document.querySelectorAll('h3')[1].textContent = data.in;
          document.querySelectorAll('h3')[2].textContent = data.out;
        }
      })
      .catch(error => {
        console.error('Erro ao buscar status:', error);
      });
  }

  // ===== Gráfico Fluxo por Hora =====
  function updateMovementChart(hourlyData) {
    const movementCtx = document.getElementById("movementChart");
    if (!movementCtx) return;

    // Garantir que sempre temos dados
    const safeHourlyData = hourlyData && hourlyData.length > 0 ? hourlyData : generateEmptyHourlyData();
    
    const labels = safeHourlyData.map(d => d.hour);
    const entriesData = safeHourlyData.map(d => d.in || 0);
    const exitsData = safeHourlyData.map(d => d.out || 0);
    
    if (movementChart) {
      movementChart.data.labels = labels;
      movementChart.data.datasets[0].data = entriesData;
      movementChart.data.datasets[1].data = exitsData;
      movementChart.data.datasets[2].data = entriesData.map((entry, i) => entry - exitsData[i]);
      movementChart.update('none');
    } else {
      movementChart = new Chart(movementCtx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Entradas",
              data: entriesData,
              borderColor: "#10b981",
              backgroundColor: "rgba(16, 185, 129, 0.1)",
              tension: 0.4,
              fill: true,
              pointBackgroundColor: "#10b981",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8
            },
            {
              label: "Saídas",
              data: exitsData,
              borderColor: "#f59e0b",
              backgroundColor: "rgba(245, 158, 11, 0.1)",
              tension: 0.4,
              fill: true,
              pointBackgroundColor: "#f59e0b",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8
            },
            {
              label: "Saldo",
              data: entriesData.map((entry, i) => entry - exitsData[i]),
              borderColor: "#6366f1",
              backgroundColor: "rgba(99, 102, 241, 0.1)",
              tension: 0.4,
              fill: false,
              borderDash: [5, 5],
              pointBackgroundColor: "#6366f1",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: { 
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                  size: 12,
                  weight: '500'
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#374151',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true
            }
          },
          scales: {
            x: { 
              grid: { display: false },
              ticks: {
                font: { size: 11 },
                maxRotation: 0
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: { size: 11 }
              },
              grid: { 
                borderDash: [2, 2],
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
          },
          elements: {
            line: {
              borderWidth: 3
            }
          }
        },
      });
    }
  }

  // ===== Gráfico Fluxo por Minuto =====
  function updateMinuteChart(minuteData) {
    const minuteCtx = document.getElementById("minuteChart");
    if (!minuteCtx) return;
    
    // Garantir que sempre temos dados
    const safeMinuteData = minuteData && minuteData.length > 0 ? minuteData : [0,0,0,0,0,0,0,0,0,0];
    
    if (minuteChart) {
      minuteChart.data.datasets[0].data = safeMinuteData;
      minuteChart.update('none');
    } else {
      minuteChart = new Chart(minuteCtx, {
        type: "bar",
        data: {
          labels: ["10min","9min","8min","7min","6min","5min","4min","3min","2min","1min"],
          datasets: [{
            label: "Detecções",
            data: safeMinuteData,
            backgroundColor: function(context) {
              const value = context.parsed.y;
              if (value === 0) return "#e5e7eb";
              if (value <= 2) return "#10b981";
              if (value <= 5) return "#f59e0b";
              return "#ef4444";
            },
            borderColor: function(context) {
              const value = context.parsed.y;
              if (value === 0) return "#d1d5db";
              if (value <= 2) return "#059669";
              if (value <= 5) return "#d97706";
              return "#dc2626";
            },
            borderWidth: 1,
            borderRadius: 4,
            borderSkipped: false,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#374151',
              borderWidth: 1,
              cornerRadius: 6,
              callbacks: {
                title: function(context) {
                  return context[0].label + ' atrás';
                },
                label: function(context) {
                  const value = context.parsed.y;
                  return value === 1 ? '1 detecção' : value + ' detecções';
                }
              }
            }
          },
          scales: {
            x: { 
              grid: { display: false },
              ticks: {
                font: { size: 10 },
                color: '#6b7280'
              }
            },
            y: {
              beginAtZero: true,
              ticks: { 
                display: true,
                stepSize: 1,
                font: { size: 10 },
                color: '#6b7280'
              },
              grid: { 
                display: true,
                color: 'rgba(0, 0, 0, 0.05)',
                borderDash: [2, 2]
              },
            },
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        },
      });
    }
  }

  // Inicializar gráficos
  initializeWithStaticData(); // Inicializar primeiro com dados estáticos
  updateCharts(); // Depois tentar atualizar com dados dinâmicos
  updateCounters();
  
  // Atualizar gráficos a cada 30 segundos
  setInterval(updateCharts, 30000);
  
  // Atualizar contadores a cada 5 segundos
  setInterval(updateCounters, 5000);

});
</script>

{% endblock %}
